let o=!1;async function s(){if(o)return;if((await chrome.runtime.getContexts({contextTypes:[chrome.runtime.ContextType.OFFSCREEN_DOCUMENT],documentUrls:[chrome.runtime.getURL("src/offscreen/offscreen.html")]})).length>0){o=!0;return}await chrome.offscreen.createDocument({url:"src/offscreen/offscreen.html",reasons:[chrome.offscreen.Reason.WORKERS],justification:"ONNX inference for AI image detection"}),o=!0,console.log("[UnDiffused] Offscreen document created")}async function a(n){return await s(),new Promise((t,r)=>{chrome.runtime.sendMessage({type:"ANALYZE",url:n},e=>{if(chrome.runtime.lastError){r(new Error(chrome.runtime.lastError.message));return}e!=null&&e.success?t({isAI:e.isAI,confidence:e.confidence,heatmapData:e.heatmapData||[]}):r(new Error((e==null?void 0:e.error)||"Analysis failed"))})})}async function i(n,t,r){try{await chrome.tabs.sendMessage(n,{type:"SHOW_RESULT",imageUrl:t,...r})}catch(e){console.error("[UnDiffused] Failed to send result to tab:",e)}}async function f(n,t){if(n.menuItemId!=="undiffused-scan"||!n.srcUrl||!(t!=null&&t.id))return;console.log("[UnDiffused] Scanning:",n.srcUrl);const r=t.id;try{await chrome.tabs.sendMessage(r,{type:"SCANNING",imageUrl:n.srcUrl})}catch(e){console.warn("[UnDiffused] Could not notify content script of scanning state:",e)}try{const e=await a(n.srcUrl);try{await i(r,n.srcUrl,e)}catch(c){console.warn("[UnDiffused] Could not send result to content script:",c),console.log("[UnDiffused] Result:",e.isAI?"AI-GENERATED":"REAL",e.confidence+"%")}}catch(e){console.error("[UnDiffused] Analysis failed:",e);try{await chrome.tabs.sendMessage(r,{type:"ERROR",imageUrl:n.srcUrl,error:e instanceof Error?e.message:"Unknown error"})}catch(c){console.warn("[UnDiffused] Could not send error to content script:",c)}}}chrome.runtime.onInstalled.addListener(()=>{chrome.contextMenus.create({id:"undiffused-scan",title:"ğŸ” Scan with UnDiffused",contexts:["image"]}),console.log("[UnDiffused] Context menu created")});chrome.contextMenus.onClicked.addListener(f);console.log("[UnDiffused] Background service worker ready");
