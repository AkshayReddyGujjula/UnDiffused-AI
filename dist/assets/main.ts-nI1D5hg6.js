let s=!1;async function a(){if(s)return;if((await chrome.runtime.getContexts({contextTypes:[chrome.runtime.ContextType.OFFSCREEN_DOCUMENT],documentUrls:[chrome.runtime.getURL("src/offscreen/offscreen.html")]})).length>0){s=!0;return}await chrome.offscreen.createDocument({url:"src/offscreen/offscreen.html",reasons:[chrome.offscreen.Reason.WORKERS],justification:"ONNX inference for AI image detection"}),s=!0,console.log("[UnDiffused] Offscreen document created")}async function o(r){return await a(),new Promise((n,t)=>{chrome.runtime.sendMessage({type:"ANALYZE",url:r},e=>{if(chrome.runtime.lastError){t(new Error(chrome.runtime.lastError.message));return}e!=null&&e.success?n({isAI:e.isAI,confidence:e.confidence,heatmapData:e.heatmapData||[],filterData:e.filterData||[]}):t(new Error((e==null?void 0:e.error)||"Analysis failed"))})})}async function i(r,n,t){try{await chrome.tabs.sendMessage(r,{type:"SHOW_RESULT",imageUrl:n,...t})}catch(e){console.error("[UnDiffused] Failed to send result to tab:",e)}}async function f(r,n){if(r.menuItemId!=="undiffused-scan"||!r.srcUrl||!(n!=null&&n.id))return;console.log("[UnDiffused] Scanning:",r.srcUrl);const t=n.id;try{await chrome.tabs.sendMessage(t,{type:"SCANNING",imageUrl:r.srcUrl})}catch(e){console.warn("[UnDiffused] Could not notify content script of scanning state:",e)}try{const e=await o(r.srcUrl);try{await i(t,r.srcUrl,e)}catch(c){console.warn("[UnDiffused] Could not send result to content script:",c),console.log("[UnDiffused] Result:",e.isAI?"AI-GENERATED":"REAL",e.confidence+"%")}}catch(e){console.error("[UnDiffused] Analysis failed:",e);try{await chrome.tabs.sendMessage(t,{type:"ERROR",imageUrl:r.srcUrl,error:e instanceof Error?e.message:"Unknown error"})}catch(c){console.warn("[UnDiffused] Could not send error to content script:",c)}}}chrome.runtime.onInstalled.addListener(()=>{chrome.contextMenus.create({id:"undiffused-scan",title:"ðŸ” Scan with UnDiffused",contexts:["image"]}),console.log("[UnDiffused] Context menu created")});chrome.contextMenus.onClicked.addListener(f);chrome.runtime.onMessage.addListener((r,n,t)=>{if(r.type==="REQUEST_ANALYSIS")return o(r.url||"").then(e=>{t({success:!0,...e})}).catch(e=>{console.error("[UnDiffused] Analysis error:",e),t({success:!1,error:e.message})}),!0});console.log("[UnDiffused] Background service worker ready");
