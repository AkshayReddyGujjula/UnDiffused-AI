async function u(t,n){if(t.menuItemId==="undiffused-scan"&&!(!t.srcUrl||!(n!=null&&n.id))){console.log("[UnDiffused] Triggering scan for:",t.srcUrl);try{await chrome.tabs.sendMessage(n.id,{type:"SCANNING",imageUrl:t.srcUrl})}catch(c){console.warn("[UnDiffused] Could not notify content script:",c)}}}chrome.runtime.onInstalled.addListener(()=>{chrome.contextMenus.create({id:"undiffused-scan",title:"ðŸ” Scan with UnDiffused",contexts:["image"]}),console.log("[UnDiffused] Context menu created")});chrome.contextMenus.onClicked.addListener(u);chrome.runtime.onMessage.addListener((t,n,c)=>{if(t.type==="FETCH_IMAGE_AS_DATA_URL"){const s=t.url;if(!s){c({success:!1,error:"No URL provided"});return}return fetch(s).then(e=>{if(!e.ok)throw new Error(`HTTP ${e.status}: ${e.statusText}`);return e.blob()}).then(e=>{const r=new FileReader;r.onloadend=()=>{c({success:!0,dataUrl:r.result})},r.onerror=()=>{c({success:!1,error:"Failed to read blob"})},r.readAsDataURL(e)}).catch(e=>{console.error("[UnDiffused] Image fetch error:",e),c({success:!1,error:e.message})}),!0}if(t.type==="TRIGGER_SCAN_FROM_POPUP"){const s=t.url;return chrome.tabs.query({active:!0,currentWindow:!0},async e=>{const r=e[0];if(!(r!=null&&r.id)){c({success:!1,error:"No active tab found"});return}try{await chrome.tabs.sendMessage(r.id,{type:"SCANNING",imageUrl:s}),c({success:!0})}catch(o){console.error("[UnDiffused] Popup scan failed:",o),chrome.tabs.sendMessage(r.id,{type:"ERROR",error:o.message||"Scan trigger failed"}).catch(a=>console.warn("Could not send error to tab:",a)),c({success:!1,error:o.message})}}),!0}});console.log("[UnDiffused] Background service worker ready");
