let c=!1;async function s(){if(c)return;if((await chrome.runtime.getContexts({contextTypes:[chrome.runtime.ContextType.OFFSCREEN_DOCUMENT],documentUrls:[chrome.runtime.getURL("src/offscreen/offscreen.html")]})).length>0){c=!0;return}await chrome.offscreen.createDocument({url:"src/offscreen/offscreen.html",reasons:[chrome.offscreen.Reason.WORKERS],justification:"ONNX inference for AI image detection"}),c=!0,console.log("[UnDiffused] Offscreen document created")}async function o(e){return await s(),new Promise((r,n)=>{chrome.runtime.sendMessage({type:"ANALYZE",url:e},t=>{if(chrome.runtime.lastError){n(new Error(chrome.runtime.lastError.message));return}t!=null&&t.success?r({isAI:t.isAI,confidence:t.confidence}):n(new Error((t==null?void 0:t.error)||"Analysis failed"))})})}async function i(e,r,n){try{await chrome.tabs.sendMessage(e,{type:"SHOW_RESULT",imageUrl:r,...n})}catch(t){console.error("[UnDiffused] Failed to send result to tab:",t)}}async function a(e,r){if(e.menuItemId==="undiffused-scan"&&!(!e.srcUrl||!(r!=null&&r.id))){console.log("[UnDiffused] Scanning:",e.srcUrl),await chrome.tabs.sendMessage(r.id,{type:"SCANNING",imageUrl:e.srcUrl});try{const n=await o(e.srcUrl);await i(r.id,e.srcUrl,n)}catch(n){console.error("[UnDiffused] Analysis failed:",n),await chrome.tabs.sendMessage(r.id,{type:"ERROR",imageUrl:e.srcUrl,error:n instanceof Error?n.message:"Unknown error"})}}}chrome.runtime.onInstalled.addListener(()=>{chrome.contextMenus.create({id:"undiffused-scan",title:"ğŸ” Scan with UnDiffused",contexts:["image"]}),console.log("[UnDiffused] Context menu created")});chrome.contextMenus.onClicked.addListener(a);console.log("[UnDiffused] Background service worker ready");
