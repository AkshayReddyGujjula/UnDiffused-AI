let o=!1;async function l(){if(o)return;if((await chrome.runtime.getContexts({contextTypes:[chrome.runtime.ContextType.OFFSCREEN_DOCUMENT],documentUrls:[chrome.runtime.getURL("src/offscreen/offscreen.html")]})).length>0){o=!0;return}await chrome.offscreen.createDocument({url:"src/offscreen/offscreen.html",reasons:[chrome.offscreen.Reason.WORKERS],justification:"ONNX inference for AI image detection"}),o=!0,console.log("[UnDiffused] Offscreen document created")}async function i(r){return await l(),new Promise((a,t)=>{chrome.runtime.sendMessage({type:"ANALYZE",url:r},e=>{if(chrome.runtime.lastError){t(new Error(chrome.runtime.lastError.message));return}e!=null&&e.success?a({isAI:e.isAI,confidence:e.confidence,heatmapData:e.heatmapData||[],filterData:e.filterData||[]}):t(new Error((e==null?void 0:e.error)||"Analysis failed"))})})}async function u(r,a,t){try{await chrome.tabs.sendMessage(r,{type:"SHOW_RESULT",imageUrl:a,...t})}catch(e){console.error("[UnDiffused] Failed to send result to tab:",e)}}async function d(r,a){if(r.menuItemId!=="undiffused-scan"||!r.srcUrl||!(a!=null&&a.id))return;console.log("[UnDiffused] Scanning:",r.srcUrl);const t=a.id;try{await chrome.tabs.sendMessage(t,{type:"SCANNING",imageUrl:r.srcUrl})}catch(e){console.warn("[UnDiffused] Could not notify content script of scanning state:",e)}try{const e=await i(r.srcUrl);try{await u(t,r.srcUrl,e)}catch(n){console.warn("[UnDiffused] Could not send result to content script:",n),console.log("[UnDiffused] Result:",e.isAI?"AI-GENERATED":"REAL",e.confidence+"%")}}catch(e){console.error("[UnDiffused] Analysis failed:",e);try{await chrome.tabs.sendMessage(t,{type:"ERROR",imageUrl:r.srcUrl,error:e instanceof Error?e.message:"Unknown error"})}catch(n){console.warn("[UnDiffused] Could not send error to content script:",n)}}}chrome.runtime.onInstalled.addListener(()=>{chrome.contextMenus.create({id:"undiffused-scan",title:"ðŸ” Scan with UnDiffused",contexts:["image"]}),console.log("[UnDiffused] Context menu created")});chrome.contextMenus.onClicked.addListener(d);chrome.runtime.onMessage.addListener((r,a,t)=>{if(r.type==="REQUEST_ANALYSIS")return i(r.url||"").then(e=>{t({success:!0,...e})}).catch(e=>{console.error("[UnDiffused] Analysis error:",e),t({success:!1,error:e.message})}),!0;if(r.type==="FETCH_IMAGE_AS_DATA_URL"){const e=r.url;if(!e){t({success:!1,error:"No URL provided"});return}return fetch(e).then(n=>{if(!n.ok)throw new Error(`HTTP ${n.status}: ${n.statusText}`);return n.blob()}).then(n=>{const c=new FileReader;c.onloadend=()=>{t({success:!0,dataUrl:c.result})},c.onerror=()=>{t({success:!1,error:"Failed to read blob"})},c.readAsDataURL(n)}).catch(n=>{console.error("[UnDiffused] Image fetch error:",n),t({success:!1,error:n.message})}),!0}if(r.type==="TRIGGER_SCAN_FROM_POPUP"){const e=r.url;return chrome.tabs.query({active:!0,currentWindow:!0},async n=>{const c=n[0];if(!(c!=null&&c.id)){t({success:!1,error:"No active tab found"});return}try{await chrome.tabs.sendMessage(c.id,{type:"SCANNING",imageUrl:e});const s=await i(e);await u(c.id,e,s),t({success:!0})}catch(s){console.error("[UnDiffused] Popup scan failed:",s),chrome.tabs.sendMessage(c.id,{type:"ERROR",error:s.message||"Analysis failed"}).catch(f=>console.warn("Could not send error to tab:",f)),t({success:!1,error:s.message})}}),!0}});console.log("[UnDiffused] Background service worker ready");
