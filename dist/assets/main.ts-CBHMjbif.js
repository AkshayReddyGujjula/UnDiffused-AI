let s=!1;async function i(){if(s)return;if((await chrome.runtime.getContexts({contextTypes:[chrome.runtime.ContextType.OFFSCREEN_DOCUMENT],documentUrls:[chrome.runtime.getURL("src/offscreen/offscreen.html")]})).length>0){s=!0;return}await chrome.offscreen.createDocument({url:"src/offscreen/offscreen.html",reasons:[chrome.offscreen.Reason.WORKERS],justification:"ONNX inference for AI image detection"}),s=!0,console.log("[UnDiffused] Offscreen document created")}async function a(r){return await i(),new Promise((c,t)=>{chrome.runtime.sendMessage({type:"ANALYZE",url:r},e=>{if(chrome.runtime.lastError){t(new Error(chrome.runtime.lastError.message));return}e!=null&&e.success?c({isAI:e.isAI,confidence:e.confidence,heatmapData:e.heatmapData||[],filterData:e.filterData||[]}):t(new Error((e==null?void 0:e.error)||"Analysis failed"))})})}async function u(r,c,t){try{await chrome.tabs.sendMessage(r,{type:"SHOW_RESULT",imageUrl:c,...t})}catch(e){console.error("[UnDiffused] Failed to send result to tab:",e)}}async function f(r,c){if(r.menuItemId!=="undiffused-scan"||!r.srcUrl||!(c!=null&&c.id))return;console.log("[UnDiffused] Scanning:",r.srcUrl);const t=c.id;try{await chrome.tabs.sendMessage(t,{type:"SCANNING",imageUrl:r.srcUrl})}catch(e){console.warn("[UnDiffused] Could not notify content script of scanning state:",e)}try{const e=await a(r.srcUrl);try{await u(t,r.srcUrl,e)}catch(n){console.warn("[UnDiffused] Could not send result to content script:",n),console.log("[UnDiffused] Result:",e.isAI?"AI-GENERATED":"REAL",e.confidence+"%")}}catch(e){console.error("[UnDiffused] Analysis failed:",e);try{await chrome.tabs.sendMessage(t,{type:"ERROR",imageUrl:r.srcUrl,error:e instanceof Error?e.message:"Unknown error"})}catch(n){console.warn("[UnDiffused] Could not send error to content script:",n)}}}chrome.runtime.onInstalled.addListener(()=>{chrome.contextMenus.create({id:"undiffused-scan",title:"ðŸ” Scan with UnDiffused",contexts:["image"]}),console.log("[UnDiffused] Context menu created")});chrome.contextMenus.onClicked.addListener(f);chrome.runtime.onMessage.addListener((r,c,t)=>{if(r.type==="REQUEST_ANALYSIS")return a(r.url||"").then(e=>{t({success:!0,...e})}).catch(e=>{console.error("[UnDiffused] Analysis error:",e),t({success:!1,error:e.message})}),!0;if(r.type==="FETCH_IMAGE_AS_DATA_URL"){const e=r.url;if(!e){t({success:!1,error:"No URL provided"});return}return fetch(e).then(n=>{if(!n.ok)throw new Error(`HTTP ${n.status}: ${n.statusText}`);return n.blob()}).then(n=>{const o=new FileReader;o.onloadend=()=>{t({success:!0,dataUrl:o.result})},o.onerror=()=>{t({success:!1,error:"Failed to read blob"})},o.readAsDataURL(n)}).catch(n=>{console.error("[UnDiffused] Image fetch error:",n),t({success:!1,error:n.message})}),!0}});console.log("[UnDiffused] Background service worker ready");
